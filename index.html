<!DOCTYPE HTML>
<html>
<head>
  <title>Timeline basic demo</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.4.0/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.17.0/vis.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.17.0/vis.min.css" rel="stylesheet" type="text/css" />
  <style type="text/css">
    body, html {
      font-family: sans-serif;
    }
  </style>
</head>
<body>
<div id="visualization"></div>
<div id="lineart"></div>
<div id="mynetwork"></div>

<script type="text/javascript">
  var container = document.getElementById('visualization');
  var data = [
    {id: '1', content: 'item 1', start: '2013-04-20', className:'first'},
    {id: '2', content: 'item 2', start: '2013-04-14', className:'second'},
    {id: '3', content: 'item 3', start: '2013-04-18', className:'third'},
    {id: '4', content: 'item 4', start: '2013-04-16', end: '2013-04-19', className:'fourth'},
    {id: '5', content: 'item 5', start: '2013-04-25', className:'fifth'},
    {id: '6', content: 'item 6', start: '2013-04-27', className:'sixth'}
  ];
  var options = {};
  var timeline = new vis.Timeline(container, data, options);
 //The data for our line
</script>

<script>
  var svgContainer = d3.select(".vis-timeline").append("svg")
                                      .attr("width", 1600)
                                      .attr("height", 600);

  function isNonNegativeInteger(str) {
      var n = ~~Number(str);
      return String(n) === str && n >= 0;
  }

  function getBox(name) {
    var box = {};
    box.name = name;
    var boxPosition = $('.vis-item.vis-box.'+name)[0];
    var boxDimensions = $('.vis-box.' + name + ' > .vis-item-content')[0];  
    var rangePosition = $('.vis-item.vis-range.'+name)[0];
    var rangeDimensions = $('.vis-range.' + name + ' > .vis-item-overflow > .vis-item-content')[0];  

    if( typeof(boxPosition) != 'undefined' || typeof(boxDimensions) != 'undefined'){
      if(boxPosition && boxPosition.style  && boxPosition.style.top && boxPosition.style.top.includes('px')){
        box.top = parseInt(boxPosition.style.top.replace('px', ''));
      }
      if(boxPosition && boxPosition.style && boxPosition.style.left&& boxPosition.style.left.includes('px')){
        box.left = parseInt(boxPosition.style.left.replace('px', ''));
      }
      box.height = boxDimensions.offsetHeight;
      box.width = boxDimensions.offsetWidth;
    } else {
      if( typeof(rangePosition) != 'undefined' || typeof(rangeDimensions) != 'undefined'){
        if(rangePosition && rangePosition.style  && rangePosition.style.top && rangePosition.style.top.includes('px')){
          box.top = parseInt(rangePosition.style.top.replace('px', ''));
        }
        if(rangePosition && rangePosition.style && rangePosition.style.left&& rangePosition.style.left.includes('px')){
          box.left = parseInt(rangePosition.style.left.replace('px', ''));
        }
        box.height = rangeDimensions.offsetHeight;
        box.width = rangeDimensions.offsetWidth;
      }  
    }
    if(!Number.isInteger(box.top)  || !Number.isInteger(box.left) || !Number.isInteger(box.height)  || !Number.isInteger(box.width) || 
        box.top < 0 || box.left < 0 || box.height < 0 || box.width < 0){
      box = null;  
    }
    return box;
  }
  function drawArrowTip(tip){

  }

  function drawLineFromBehindAndAbove(originBox, linkBox){
    //Three segments;
    var lines = [];
    var line = {};
    verticalDistance = ( originBox.top < linkBox.top) ? -(originBox.height/2)-15 : (originBox.height/2)+15;
   //juts out
    line = {};
    line.x1 = originBox.left + originBox.width;
    line.y1 = originBox.top + (originBox.height/2);
    line.x2 = (originBox.left + originBox.width + linkBox.left)/2;
    line.y2 = originBox.top + (originBox.height/2);
    lines.push(line);
   
    //moves  down
    line = {};
    line.x1 = (originBox.left + originBox.width + linkBox.left)/2;
    line.y1 = originBox.top + (originBox.height/2);
    line.x2 = (originBox.left + originBox.width + linkBox.left)/2;
    line.y2 = linkBox.top + (linkBox.height/2);
    lines.push(line);
    
    //moves forward
    line = {};
    line.x1 = (originBox.left + originBox.width + linkBox.left)/2;;
    line.y1 = linkBox.top + (linkBox.height/2);
    line.x2 = linkBox.left;
    line.y2 = linkBox.top + (linkBox.height/2);
    lines.push(line);

    return lines;    
  }
  function drawLineFromBehindAndBelow(originBox, linkBox){
    //three segments;
    var lines = [];
    var line = {};

    //juts out
    line = {};
    line.x1 = originBox.left + originBox.width;
    line.y1 = originBox.top + (originBox.height/2);
    line.x2 = (originBox.left + originBox.width + (linkBox.left - (originBox.left + originBox.width))/2);
    line.y2 = originBox.top + (originBox.height/2);
    lines.push(line);
    
    //moves  down
    line = {};
    line.x1 = (originBox.left + originBox.width + (linkBox.left - (originBox.left + originBox.width))/2);
    line.y1 = originBox.top + (originBox.height/2);
    line.x2 = (originBox.left + originBox.width + (linkBox.left - (originBox.left + originBox.width))/2);
    line.y2 = linkBox.top + (originBox.height/2);
    lines.push(line);
    
    //juts in 
    line = {};      
    line.x1 = (originBox.left + originBox.width + (linkBox.left - (originBox.left + originBox.width))/2);
    line.y1 = linkBox.top + (originBox.height/2);
    line.x2 = linkBox.left;
    line.y2 = linkBox.top + (linkBox.height/2);
    lines.push(line); 


    return lines;
  }
  function drawLineFromAheadAndAbove(originBox, linkBox){
    //one segment
    var lines = [];
    var line = {}
    //juts out
    line = {};
    line.x1 = originBox.left + originBox.width;
    line.y1 = originBox.top + (originBox.height/2);
    line.x2 = originBox.left + originBox.width + 15;
    line.y2 = originBox.top + (originBox.height/2);
    lines.push(line);
    
    //moves down
    line = {};
    line.x1 = originBox.left + originBox.width + 15;
    line.y1 = originBox.top + (originBox.height/2);
    line.x2 = originBox.left + originBox.width + 15;
    line.y2 = originBox.top + originBox.height + 3;
    lines.push(line);   

    //moves back
    line = {};
    line.x1 = originBox.left + originBox.width + 15;
    line.y1 = originBox.top + originBox.height +3;
    line.x2 = linkBox.left - 20;
    line.y2 = originBox.top + originBox.height +3;
    lines.push(line); 

    //moves down
    line = {};
    line.x1 = linkBox.left - 20;
    line.y1 = originBox.top + originBox.height +3;
    line.x2 = linkBox.left - 20;
    line.y2 = linkBox.top + (linkBox.height/2);
    lines.push(line);  

    //juts in
    line = {};
    line.x1 = linkBox.left - 20;
    line.y1 = linkBox.top + (linkBox.height/2);
    line.x2 = linkBox.left;
    line.y2 = linkBox.top + (linkBox.height/2);
    lines.push(line);    
    return lines;
  }
  function drawLineFromAheadAndBelow(originBox, linkBox){
    //five segments;
    var lines = [];
    var line = {}
    //juts out
    line = {};
    line.x1 = originBox.left + originBox.width;
    line.y1 = originBox.top + (originBox.height/2);
    line.x2 = originBox.left + originBox.width + 15;
    line.y2 = originBox.top + (originBox.height/2);
    lines.push(line);

    //moves up
    line = {};
    line.x1 = originBox.left + originBox.width + 15;
    line.y1 = originBox.top + (originBox.height/2);
    line.x2 = originBox.left + originBox.width + 15;
    line.y2 = originBox.top - 3;
    lines.push(line);   

    //moves back
    line = {};
    line.x1 = originBox.left + originBox.width + 15;
    line.y1 = originBox.top - 3;
    line.x2 = linkBox.left - 20;
    line.y2 = originBox.top - 3;
    lines.push(line);   

    //moves up
    line = {};
    line.x1 = linkBox.left - 20;
    line.y1 = originBox.top - 3;
    line.x2 = linkBox.left - 20;
    line.y2 = linkBox.top + (originBox.height/2);
    lines.push(line); 

    //juts out
    line = {};
    line.x1 = linkBox.left - 20;
    line.y1 = linkBox.top + (originBox.height/2);
    line.x2 = linkBox.left;
    line.y2 = linkBox.top + (originBox.height/2);
    lines.push(line);
    return lines;
  } 
  function drawLineStraightAhead(originBox, linkBox){
    //one segment
    var lines = [];
    var arrowTip = [];
    var line = {}
    //juts out
    line.x1 = originBox.left + originBox.width
    line.y1 = originBox.top + (originBox.height/2)
    line.x2 = linkBox.left;
    line.y2 = line.y1;
    lines.push(line);

    return lines;
  } 
  function drawLineStraightBehind(originBox, linkBox){
    var lines = [];
    var line = {}
    //juts out
    line = {};
    line.x1 = originBox.left + originBox.width;
    line.y1 = originBox.top + (originBox.height/2);
    line.x2 = originBox.left + originBox.width + 20;
    line.y2 = originBox.top + (originBox.height/2);
    lines.push(line);

    //moves up
    line = {};
    line.x1 = originBox.left + originBox.width + 20;
    line.y1 = originBox.top + (originBox.height/2);
    line.x2 = originBox.left + originBox.width + 20;
    line.y2 = originBox.top - 5;
    lines.push(line);   

    //moves back
    line = {};
    line.x1 = originBox.left + originBox.width + 20;
    line.y1 = originBox.top - 5;
    line.x2 = linkBox.left - 20;
    line.y2 = originBox.top - 5;
    lines.push(line);  

    //moves down
    line = {};
    line.x1 = linkBox.left - 20;
    line.y1 = originBox.top - 5;
    line.x2 = linkBox.left - 20;
    line.y2 = linkBox.top + (linkBox.height/2);
    lines.push(line);  

    //juts in
    line = {};
    line.x1 = linkBox.left - 20;
    line.y1 = linkBox.top + (linkBox.height/2);
    line.x2 = linkBox.left;
    line.y2 = linkBox.top + (linkBox.height/2);
    lines.push(line);    

    return lines;
  }   

  function drawLink(origin, link, color){
    
    var originBox = getBox(origin);
    var linkBox = getBox(link);
    var lines = [];
    
    if(originBox !== null && linkBox !== null){
      if((originBox.left + originBox.width + 10) < linkBox.left &  originBox.top < linkBox.top){
        console.log(origin + ' is behind and above ' + link);
        console.log(originBox, linkBox)
        lines = drawLineFromBehindAndAbove(originBox, linkBox);
      }      
      if((originBox.left + originBox.width + 10) < linkBox.left &  originBox.top > linkBox.top){
        console.log(origin + ' is behind and below ' + link );
        console.log(originBox, linkBox)
        lines = drawLineFromBehindAndBelow(originBox, linkBox);
      }  
      if((originBox.left + originBox.width + 35) >= linkBox.left &  originBox.top < linkBox.top){
        console.log(origin + ' is ahead and above ' + link);
        console.log(originBox, linkBox)
        lines = drawLineFromAheadAndAbove(originBox, linkBox);
      } 
      if((originBox.left + originBox.width + 35) >= linkBox.left &  originBox.top > linkBox.top){
        console.log(originBox, linkBox)
        console.log(origin + ' is ahead and below ' + link );
        lines = drawLineFromAheadAndBelow(originBox, linkBox);
      }
      if((originBox.left + originBox.width) < linkBox.left &  originBox.top === linkBox.top){
        console.log(origin + ' is behind and same height as ' + link );
        console.log(originBox, linkBox)
        lines = drawLineStraightAhead(originBox, linkBox);
      } 
      if((originBox.left + originBox.width +15) >=  linkBox.left &  originBox.top === linkBox.top){
        console.log(origin + ' is ahead and same height as ' + link );
        console.log(originBox, linkBox)
        lines = drawLineStraightBehind(originBox, linkBox);
      }      
    
      
      //Draw the lines
      var color = color; //'#' + ("000000");// + Math.random().toString(16).slice(2, 8).toUpperCase()).slice(-6)
      for(i = 0; i < lines.length; i++){
        svgContainer.append("line")
          .attr("stroke", color)
          .attr("stroke-width", "2px")
          .attr("x1", lines[i].x1)
          .attr("y1", lines[i].y1)
          .attr("x2", lines[i].x2)
          .attr("y2", lines[i].y2);                
      } 

      //Draw the arrowheads
      var lastCoords = lines[lines.length-1];
      var arrowhead = '';

      arrowhead = arrowhead +        (lastCoords.x2)  + ',' + (lastCoords.y2)
      arrowhead = arrowhead + ' ' +  (lastCoords.x2-15) + ',' + (lastCoords.y2+5) 
      arrowhead = arrowhead + ' ' +  (lastCoords.x2-15) + ',' + (lastCoords.y2-5) 
      arrowhead = arrowhead + ' ' +  (lastCoords.x2)  + ',' + (lastCoords.y2)

      svgContainer.append("polygon")      
        .style("stroke", color) 
        .style("fill", color)     
        .attr("points", arrowhead);                     
      }
  }
  timeline.on('changed', function () {
    d3.selectAll("svg > *").remove();
    var boxes = [];
    drawLink('first', 'second', 'black');
    drawLink('second', 'third', 'black');
    drawLink('third', 'fourth', 'black');
    drawLink('fourth', 'fifth', 'red');
    drawLink('fifth', 'sixth', 'black');

  });

 //Make an SVG Container

</script>
</body>
</html>
